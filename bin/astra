import click
import os
import logging
import sys

# Common options.
@click.group()
@click.option("-v", "verbose", default=False, is_flag=True,
              help="verbose mode")
@click.pass_context
def cli(context, verbose):
    context.ensure_object(dict)
    context.obj["verbose"] = verbose

# Add 'execute' sub-command.
@click.group()
@click.pass_context
def execute(context):
    pass




@click.command(context_settings=dict(ignore_unknown_options=True))
@click.option("--bundle", is_flag=True)
@click.argument("primary_key")
@click.pass_context
def execute(context, bundle, primary_key, **kwargs):
    """
    Execute a task or task bundle.
    """

    from astra import log
    from astra.database.astradb import Task, Bundle, TaskBundle

    if bundle:
        work = Bundle.get(pk=primary_key)
    else:
        work = Task.get(pk=primary_key)
    
    log.debug(f"Executing {work}")
    
    executable = work.as_executable()

    log.info(f"Executable: {executable}")

    result = executable.execute()
    
    log.info(f"Result type: {type(result)} {result}") # Pretty print?
    

cli.add_command(execute)

if __name__ == "__main__":
    cli(obj=dict())
